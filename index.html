<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <meta name="description" content="Create your tile map with this online Tile Map Editor" />
<!--    <link rel="stylesheet" href="src/styles.css" />-->

    <link rel="manifest" href="manifest.webmanifest">
    <meta name="theme-color" content="#317EFB">
    <link rel="apple-touch-icon" href="/icon.png">
    <link rel="stylesheet" type="text/css" href="index.css" />
    <script src="tilemap-editor/src/tilemap-editor.js"></script>
    <link rel="stylesheet" type="text/css" href="tilemap-editor/src/styles.css" />
    <script src="kaboom/kaboom.js"></script>


    <script src="/ace-builds/src-noconflict/ace.js" type="text/javascript" charset="utf-8"></script>
    <script src="/ace-builds/src-noconflict/ext-language_tools.js"></script>

    <title>Kaboom Playground +</title>
  </head>
  <body>

  <button id="addPwaBtn" >üç∞ Install pwa</button>
  <div id="snackbar">A new version of this app is available.<a id="reload"> Click here to update.</a></div>


  <div class="tabs">
    <div class="head-tab">
      <input type="radio" id="tab1" name="tab-group">
      <label for="tab1">Map</label>
      <div class="head-tab-content">
        <div id="tileMapEditor"></div>
      </div>
    </div>
    <div class="head-tab">
      <input type="radio" id="tab2" name="tab-group">
      <label for="tab2">Code</label>
      <div class="head-tab-content">
        <div id="editor">err</div>
      </div>
    </div>
    <div class="head-tab">
      <input type="radio" id="tab3" name="tab-group">
      <label for="tab3">Play</label>
      <div class="head-tab-content">
        <p>text 3</p>
      </div>
    </div>

  </div>


  <script type="module" src="importers/tiled.js"></script>
<!--  <script type="application/json" id="typeData" src="utils/typeData.json"></script>-->
  <script type="module" src="utils/typeData.js"></script>
  <script type="module" src="utils/aceTools.js"></script>
  <script type="module" src="utils/helpers.js"></script>

  <script type="module">
    import importTiledJson from './importers/tiled.js';
    import { setEditorAutoCompleter } from './utils/aceTools.js';
    import {store, storeSetValue, saveStateOnElementWhenEvent, loadFromStoreOnStart,
      getMapFromGist, getImgurGallery, uploadImageToImgur, initTileMapUrl, initPwaLogic, initTilemapEditor
    } from './utils/helpers.js';
    importTiledJson();

    saveStateOnElementWhenEvent('tab1','change', 'activeTab', 1, 'checked')
    saveStateOnElementWhenEvent('tab2','change', 'activeTab', 2, 'checked')
    saveStateOnElementWhenEvent('tab3','change', 'activeTab', 3, 'checked')
    loadFromStoreOnStart()

    ace.require("ace/ext/language_tools");
    const editor = ace.edit("editor", {
      theme: 'ace/theme/monokai',
      mode: 'ace/mode/javascript',
      value: store['editorValue'].value,
      autoScrollEditorIntoView: true,
      enableBasicAutocompletion: true,
      enableLiveAutocompletion: true,
      behavioursEnabled: true,
    });
    editor.getSession().on('change', ev => {
      storeSetValue('editorValue', editor.getValue())
    });
    setEditorAutoCompleter(editor);

    // Example data structure that tiledmap-editor can read and write
    //https://imgur.com/a/SjjsjTm
    // kaboomJs example exporter
    const kaboomJsExport = ({flattenedData, maps, tileSets, activeMap, downloadAsTextFile}) =>{
      const getTileData = (tileSet, tileSetIdx) => Array.from({length: tileSet.tileCount}, (x, i) => i).map(tile=>{
        const x = tile % tileSet.gridWidth;
        const y = Math.floor(tile / tileSet.gridWidth);
        const tileKey = `${x}-${y}`;

        const tags = Object.keys(tileSet.tags).filter(tagKey => !!tileSet.tags[tagKey]?.tiles[tileKey]);
        return `"${tileSet.tileData[tileKey]?.tileSymbol}": [
          sprite("tileset-${tileSetIdx}", { frame: ${tile}, }),
          ${tags?.join(",")|| ""}
        ],`
      }).join("\n")

      const getAsciiMap = (flattenedDataLayer) => `\n${flattenedDataLayer.map((row,rowIndex) => "'" + row.map(tile => tile.tileSymbol).join("")).join("',\n") + "'"}`;

      console.log("TILESETS", tileSets, flattenedData)
      const kaboomBoiler = `
      kaboom({
        global: true,
        fullscreen: true,
        scale: 1,
        debug: true,
        clearColor: [0, 0, 0, 1],
      });

      // Load assets
      ${Object.values(tileSets).map((tileSet, tileSetIdx) => `
            loadSprite("tileset-${tileSetIdx}", "${tileSet.src}", {
            sliceX: ${tileSet.gridWidth},
            sliceY: ${tileSet.gridHeight},
        });
      `).join("\n")}


      scene("main", () => {
      // tileset
        ${Object.values(tileSets).map((tileSet, tileSetIdx) => `
            const tileset_${tileSetIdx}_data = {
            width: ${tileSet.tileSize},
            height: ${tileSet.tileSize},
            pos: vec2(0, 0),
             ${getTileData(tileSet, tileSetIdx)}
             };
        `).join("\n")}
      // maps
      ${flattenedData.map((map, index)=>`
        const map_${index} = [${getAsciiMap(map.flattenedData[map.flattenedData.length - 1])}];
      `).join("\n")}

      addLevel(map_0, tileset_0_data);
      })

      start("main");
      `;
      console.log(kaboomBoiler)
      // return the transformed data in the end
      return kaboomBoiler
    };
    initTilemapEditor();
    // console.log("Got App State:",TilemapEditor.getState())
    window.addEventListener('beforeunload', function(event) {
      storeSetValue('editorValue', editor.getValue())
      storeSetValue('tileMapEditorData', TilemapEditor.getState());
    });
    initTileMapUrl();
    // Pwa stuff
    initPwaLogic();
  </script>

  <style>
    #addPwaBtn {
      position: absolute;
      bottom: 10px;
      left: 50%;
      background: #1a1a1a;
      color: yellow;
      border: 1px solid grey;
      border-radius: 3px;
      padding: 10px;
    }
  </style>

  </body>
</html>
