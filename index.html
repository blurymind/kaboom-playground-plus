<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <meta name="description" content="Create your tile map with this online Tile Map Editor" />
<!--    <link rel="stylesheet" href="src/styles.css" />-->

    <link rel="manifest" href="manifest.webmanifest">
    <meta name="theme-color" content="#317EFB">
    <link rel="apple-touch-icon" href="/icon.png">
    <link rel="icon" href="/favicon.svg" />
    <link rel="stylesheet" type="text/css" href="index.css" />
    <script src="tilemap-editor/src/tilemap-editor.js"></script>
    <link rel="stylesheet" type="text/css" href="tilemap-editor/src/styles.css" />
    <script src="kaboom/kaboom.js"></script>


    <script src="/ace-builds/src-noconflict/ace.js" type="text/javascript" charset="utf-8"></script>
    <script src="/ace-builds/src-noconflict/ext-language_tools.js"></script>

    <title>Kaboom Playground +</title>
  </head>
  <body>

  <button id="addPwaBtn" >üç∞ Install pwa</button>
  <div id="snackbar">A new version of this app is available.<a id="reload"> Click here to update.</a></div>


  <div class="tabs">
    <div class="head-tab">
      <input type="radio" id="tab1" name="tab-group" checked="true">
      <label for="tab1">Map</label>
      <div class="head-tab-content">
        <div id="tileMapEditor"></div>
      </div>
    </div>
    <div class="head-tab">
      <input type="radio" id="tab2" name="tab-group">
      <label for="tab2">Code</label>
      <div class="head-tab-content">
        <div id="aceSplitScreenToggle" style="right:50%; display:none">‚û°Ô∏è</div>
        <div class="editor-tab">
          <div class="editor-wrapper"><div id="editor">err</div></div>
          <div class="kaboom-wrapper">
            <div id="kbEditor" class="kb-behind-mode"> </div>
            <div id="joyStick"></div>
          </div>
        </div>

      </div>
    </div>
    <div class="head-tab">
      <input type="radio" id="tab3" name="tab-group">
      <label for="tab3">Play</label>
      <div class="head-tab-content">
        <p>text 3</p>
      </div>
    </div>
    <div id="reloadKb">üí•</div>


    <div class="progressBar">
      <div id="storageProgressBar"> 1% </div>
    </div>


  </div>

  <script type="module" src="utils/seed.js"></script>
  <script type="module" src="importers/tiled.js"></script>
<!--  <script type="application/json" id="typeData" src="utils/typeData.json"></script>-->
  <script type="module" src="utils/typeData.js"></script>
  <script type="module" src="utils/aceTools.js"></script>
  <script type="module" src="utils/helpers.js"></script>
  <script type="module" src="utils/joystick.js"></script>

  <script type="module">
    // import {kaboom} from "./kaboom/kaboom.js"
    import importTiledJson from './importers/tiled.js';
    import { setEditorAutoCompleter } from './utils/aceTools.js';
    import { JoyStick } from './utils/joystick.js';
    import {store, storeSetValue, saveStateOnElementWhenEvent, loadFromStoreOnStart, initTileMapUrl, initPwaLogic,
      initTilemapEditor, genPreview, kaboomJsExport, triggerOnElementWhenEvent, getValueFromStore, setStorage
    } from './utils/helpers.js';
    import {aceEditorSeed, tilemapEditorSeed} from './utils/seed.js'
    importTiledJson();


    loadFromStoreOnStart()

    ace.require("ace/ext/language_tools");
    const editor = ace.edit("editor", {
      theme: 'ace/theme/dracula',
      mode: 'ace/mode/javascript',
      value: getValueFromStore('editorValue', aceEditorSeed),
      autoScrollEditorIntoView: true,
      enableBasicAutocompletion: true,
      enableLiveAutocompletion: true,
      behavioursEnabled: true,
      useWrapMode: true,
    });
    editor.getSession().on('change', ev => {
      storeSetValue('editorValue', editor.getValue())
    });
    setEditorAutoCompleter(editor);

    const control = new JoyStick({
      element: document.getElementById("joyStick"),
      style: `
        // width: 200px;
        // height: 200px;
        // bottom: 10px;
        // left: 100px;
      `,
      sensitivity: 0.5 // half from distance triggers directions
    });

    document.getElementById("aceSplitScreenToggle").addEventListener("click", function() {
      let isEditorWide = false; //todo toggle
      document.getElementById("aceSplitScreenToggle").style.right = isEditorWide ? "0%" : undefined;
      document.getElementById("editor").style.right = isEditorWide ? 0 : "50vw";
      document.getElementById("editor").style.opacity = isEditorWide ? 0.85 : undefined;
      document.getElementById("kaboomIframe").style.width = isEditorWide ? "90vw" : undefined;
      isEditorWide = !isEditorWide
    })
    // Example data structure that tiledmap-editor can read and write
    //https://imgur.com/a/SjjsjTm
    // kaboomJs example exporter


    export const initKaboom = (tileMapEditorState) => {
      // console.log("Ini KABOOM", tileMapEditorState,"KB data:", TilemapEditor.exporters.kaboomJs.getData())
      const kaboomIframe = document.createElement('iframe');
      kaboomIframe.id = 'kaboomIframe';
      const iframeWrapper = document.createElement('div');
      iframeWrapper.id = 'kaboomCanvas';
      iframeWrapper.appendChild(kaboomIframe);
      document.getElementById('kbEditor').appendChild(iframeWrapper);
      const reRun = () => {
        const kbExportData = TilemapEditor.exporters.kaboomJs.getData()
        const tileMapData = getValueFromStore('tileMapEditorData', tilemapEditorSeed, tileMapEditorState)
        console.log({editor: editor.getValue(), tileMapData, TilemapEditor, kbExportData})
        kaboomIframe.srcdoc = genPreview(
                editor.getValue(),
                [
                        {file:"kaboom/sprites/bean.png", name: "bean"},
                        {file:"kaboom/sprites/ghosty.png", name: "ghosty"},
                ]//todo add to json editor - with file and name schema - ability to load files from url and base64
        );
        setTimeout(()=>{
          // kaboomIframe.contentWindow.focus();
        }, 200)
      };
      reRun()
      document.getElementById('reloadKb').addEventListener('click', ()=>{
        reRun()
      })

      kaboomIframe.addEventListener('load', ()=> {
        const pauseGame = ()=> kaboomIframe.contentWindow?.pauseGame?.();
        const unPauseGame = ()=> kaboomIframe.contentWindow?.unPauseGame?.();
        editor.on('focus',pauseGame);
        editor.on('blur',unPauseGame);
        kaboomIframe.addEventListener('click', unPauseGame);
        setTimeout(()=>editor.focus(),200);
      })

    }


    // destroy kaboom when not on tab
    function onTabChange(tab){
      console.log("tab changed", tab)
      const tileMapEditorData = getValueFromStore('tileMapEditorData', {});
      // saveAppState();
      if(tab !== 'tab2') {
        console.log("destroy tab")
        document.getElementById('kbEditor').innerHTML = "";
      } else { //on kaboom
        // get it from stored state instead
        initKaboom(tileMapEditorData)
      }
    }
    saveStateOnElementWhenEvent('tab1','change', 'activeTab', 1, 'checked')
    saveStateOnElementWhenEvent('tab2','change', 'activeTab', 2, 'checked')
    saveStateOnElementWhenEvent('tab3','change', 'activeTab', 3, 'checked')
    triggerOnElementWhenEvent('tab1','change',onTabChange)
    triggerOnElementWhenEvent('tab2','change',onTabChange)
    triggerOnElementWhenEvent('tab3','change',onTabChange)

    initTilemapEditor();
    if (getValueFromStore('activeTab', 0) === 2) initKaboom(getValueFromStore('activeTab', 0))
    // console.log("Got App State:",TilemapEditor.getState())
    document.addEventListener('beforeunload', function(event) {
      alert("unload")
      // saveAppState();
    });
    // TilemapEditor.onUpdate(state=>{
    //   console.log("Updated", state)
    // }, 200)
    initTileMapUrl();
    // Pwa stuff
    initPwaLogic();
  </script>

  <style>
    #addPwaBtn {
      position: absolute;
      bottom: 10px;
      left: 50%;
      background: #1a1a1a;
      color: yellow;
      border: 1px solid grey;
      border-radius: 3px;
      padding: 10px;
    }
  </style>

  </body>
</html>
